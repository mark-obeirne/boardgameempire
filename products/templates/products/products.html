{% extends 'base.html' %}

{% load static %}

{% block content %}
    <div class="container bg-light text-brown">
        <h1 class="text-brown small-caps bold">All Boardgames</h1>
        <div class="row">
            <div class="col s12">
                <p>Showing {{ number_of_results }} {% if number_of_results == 1 %}result{% else %}results{% endif %}{% if query %} for <strong>{{ query }}</strong>{% endif %}</p>
            </div>
            <!--Button to display available filters-->
            <div class="col s12">
                <a href="#" class="waves-effect waves-light btn bg-brown text-light">Filters</a>
            </div>
        <!--If current filters
            <div class="col s8">
            Current Filters:
        </div>-->
        </div>
        <div class="row">
            <div class="input-field browser-default col s6">
            <!--Sort selection dropdown-->
            <select id="sort-select-dropdown" name="sort-select-dropdown" class="sort-select-dropdown">
                <option value="reset" disabled {% if current_sorting == "None-None" %}selected{% endif %}>Sort By</option>
                <optgroup label="Alphabetically">
                    <option value="name-asc" {% if current_sorting == "name-asc" %}selected{% endif %}>Name (A-Z)</option>
                    <option value="name-desc" {% if current_sorting == "name-desc" %}selected{% endif %}>Name (Z-A)</option>
                </optgroup>
                <optgroup label="By Price">
                    <option value="price-asc" {% if current_sorting == "price-asc" %}selected{% endif %}>Price (Low to High)</option>
                    <option value="price-desc" {% if current_sorting == "price-desc" %}selected{% endif %}>Price (High to Low)</option>
                </optgroup>
                <optgroup label="Min Players">
                    <option value="min_players-asc" {% if current_sorting == "min_players-asc" %}selected{% endif %}>Min Players (Low to High)</option>
                    <option value="min_players-desc" {% if current_sorting == "min_players-desc" %}selected{% endif %}>Min Players (High to Low)</option>
                </optgroup>
                <optgroup label="Max Players">
                    <option value="max_players-desc" {% if current_sorting == "max_players-desc" %}selected{% endif %}>Max Players (High to Low)</option>
                    <option value="max_players-asc" {% if current_sorting == "max_players-asc" %}selected{% endif %}>Max Players (Low to High)</option>
                </optgroup>
                <optgroup label="Playtime">
                    <option value="playing_time-asc" {% if current_sorting == "playing_time-asc" %}selected{% endif %}>Playtime (Shortest to Longest)</option>
                    <option value="playing_time-desc" {% if current_sorting == "playing_time-desc" %}selected{% endif %}>Playtime (Longest to Shortest)</option>
                </optgroup>
            </select>
            <label for="sort-select-dropdown">{% if current_sorting != "None-None" %}Currently Sorting By: {% else %}Select Product Sorting{% endif %}</label>
            </div>
        </div>
    <div class="row">
        <div class="products-panel col s12">
            <!--Products-->
            {% for product in products %}
            <div class="col s12 m6 l4">
                <div class="card center-align product-card">
                    <div class="card-image">
                        {% if product.boxart %}
                            <img src="{{ product.boxart.url }}" alt="{{ product.name }} box" class="responsive-img">
                        {% else %}
                            <img src="/media/noimage.png" alt="{{ product.name}}" class="responsive-img">
                        {% endif %}
                    </div>
                    <div class="card-content">
                        <h3 class="card-title small-caps"><a href="{% url 'product_detail' product.id %}" class="text-brown bold">{{ product.name }}</a></h3>
                        {% if product.on_sale %}
                            <p><s class="sale-strikethrough">{{ product.price }}</s> {{ product.sale_price }}</p>
                        {% else %}
                            <p>â‚¬{{ product.price }}</p>
                        {% endif %}
                        <p>{{ product.rating }}</p>
                        <div class="product-action-btns margin-t1">
                            <a href="{% url 'product_detail' product.id %}" class="waves-effect waves-light btn details-btn bg-brown text-light"><i class="fas fa-eye prefix"></i> More Details</a>
                            <div class="quantity-field margin-t1 last-btn">
                                {% if product.inventory > 0 %}
                                <form class="form" method="POST" action="{% url 'add_to_cart' product.id %}">
                                    {% csrf_token %}
                                    <span class="qty-btn qty-decrease" data-product-id="{{ product.id }}" id="decrease-qty_{{ product.id }}"><i class="fas fa-minus-square text-brown"></i></span>
                                    <input class="product-qty-input narrow-input" type="number" name="quantity" value="1" min="1" max="{{ product.inventory }}" data-item_id="{{ product.id }}" id="product-qty-input">
                                    <span class="qty-btn qty-increase" data-product-id="{{ product.id }}" id="increase-qty_{{ product.id }}"><i class="fas fa-plus-square text-brown"></i></span>
                                    <button class="btn waves-effect waves-light text-light bg-brown qty-submit block" id="add-cart-btn" type="submit" name="action">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>
                                    <input type="hidden" name="redirect_url" value="{{ request.path }}">
                                </form>
                                {% else %}
                                    <a href="#" class="waves-effect waves-light btn disabled"><i class="fas fa-frown prefix"></i> Out of Stock</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const elems = document.querySelectorAll('select');
            const instances = M.FormSelect.init(elems, {});
        });
    </script>

    <script type="text/javascript">
        const selectDropdown = document.querySelectorAll(".sort-select-dropdown")
        selectDropdown.forEach(dropdown => dropdown.addEventListener("change", function() {
            const chosenSorting = this.value;
            console.log(chosenSorting)
            const currentUrl = new URL(window.location);

            if (chosenSorting != "reset") {
                const sort = chosenSorting.split("-")[0]
                const direction = chosenSorting.split("-")[1]
                
                currentUrl.searchParams.set("sort", sort);
                currentUrl.searchParams.set("direction", direction);

                window.location.replace(currentUrl);
            } else {
                currentUrl.searchParams.set("sort");
                currentUrl.searchParams.set("direction");

                window.location.replace(currentUrl);
            }
        }))
    </script>
{% endblock %}